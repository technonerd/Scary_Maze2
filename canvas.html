<html>
  <style>
    #c {border:solid black 5px;}
	span {
		cursor: url("https://41.media.tumblr.com/9bacd3a11a531af3ef2cdc4245d6c1c3/tumblr_njstm24OLg1r4nao1o1_75sq.png"), auto;
		}
  </style>

<script src="/socket.io/socket.io.js"></script>

  <div style="text-align:center">
  	<div id="header" style="font-size:30pt;font-family:Helvetica Neue">Click on blue to proceed</div>
  <span>
    <canvas id="c" width="1100" height="650">
    </canvas>
	</span>
  <audio id="player" src="static/au1.mp3" type="audio/mpeg" autoplay> </audio>
  </div>
  

<script>
function nextSong(){
  document.getElementById('player').src = 'static/au'+(lev-4)+'.mp3';
}

var c = document.getElementById("c");
var ctx = c.getContext("2d");
var lev = 5;
var maxlev = 10;

var update = function(){
    ctx.fillStyle = "#000000";
    ctx.fillRect(0,0,c.getAttribute("width"),c.getAttribute("height"));
}
var nextimg = function(){
    lev++;
    if (lev < 6){
        document.getElementById("header").innerHTML = "Click on a rectangle to proceed";
	   return "Start" + lev + ".png"; 
    }
    else{
       return "level" + (lev-5) + ".png";
    }
};
var makeMaze = function(ctx,img,imgsrc){
    return {
	x:10,
	y:10,
	ctx:ctx,
	img:img,
	imgsrc:imgsrc,
	draw:function(){
	    this.img.src ="static/" + this.imgsrc;
	    ctx.drawImage(this.img,this.x,this.y);
	  
	    //this.img.border = "solid red 10px";
	}
    }
}
var img = new Image();
var imgsrc = nextimg();
 
c.addEventListener("onload", function(e){
    var maze = makeMaze(ctx,img,imgsrc);
    maze.draw();
});
var canmove=false;
console.log("false");
c.addEventListener("click",function(e){
    update();
    var maze = makeMaze(ctx,img,imgsrc);
    maze.draw();
    var rect = c.getBoundingClientRect();
    var mouseX = e.clientX - rect.left;
    var mouseY = e.clientY - rect.top;
    
    mouseX = mouseX-1;
    mouseY = mouseY-1;
    if (mouseX <1){
    mouseX++;
    }
    if (mouseY<1){
    mouseY++;
    }

    var po = ctx.getImageData(mouseX,mouseY,1,1).data;
    if (po[0]==200 && po[1] ==200 && po[2]==0){
        imgsrc=nextimg();
        update();
        if (lev>5){
            maze = makeMaze(ctx,img,imgsrc);
            maze.draw();
        }
    }
    else if (po[0]==0 && po[1] ==84 && po[2]==166){
        canmove=true;
        document.getElementById("header").innerHTML = "Go!";
    }
});

c.addEventListener("mousemove", function(e){
    update();
    var maze = makeMaze(ctx,img,imgsrc);
    maze.draw();
    var rect = c.getBoundingClientRect();
    var mouseX = e.clientX - rect.left;
    var mouseY = e.clientY - rect.top;
    
    mouseX = mouseX-1;
    mouseY = mouseY-1;
    if (mouseX <1){
	mouseX++;
    }
    if (mouseY<1){
	mouseY++;
    }

    var p = ctx.getImageData(mouseX,mouseY,1,1).data;
    console.log("___");

    if (p[0]==0 && p[1] ==0 && p[2]==0 && canmove){
	//console.log("black");
        maze = makeMaze(ctx,img,imgsrc);
        maze.draw();
        canmove=false;
        document.getElementById("header").innerHTML = "Try again - Click blue to proceed";
    }
    if (p[0]==255 && p[1] ==0 && p[2]==0 && canmove){
	console.log("win");
	imgsrc="Loading.png";
	maze = makeMaze(ctx,img,imgsrc);
	maze.draw();
	canmove=false;
	document.getElementById("header").innerHTML = "Wait...";
  alert("hi");
  nextSong();
	winner();
    }
});

var win = false;
var socket = io();
var winnum = 0;
/* sends a msg to server that there is a winner  */

var winner = function(){
    win = true;
    if (win){
        console.log(win);
        socket.emit('winner', { winner: "You have won" });
    };
    
};
/* end everything */
var end_everything = function(){
  console.log("CLOSING=====" + win);
  if (!win){
//socket- connection

       //turn off game
      update();
       //face
      var img = new Image;
      var t = setTimeOut(function(){
	  ctx.drawImage(img,150,25);
      }, 3000);
       //music 
      window.clearTimeout(t);
      update();
    } else{
		 console.log("winner");
    winnum++;
  }

   win = false;
   console.log("CLOSING=====" + win);
    
}
/* loading a new level for only client side*/
socket.on("new_level", function(){
//refresh winning status
var d = document.getElementById("d");
console.log("new LEVELS");
d.setAttribute("style", "background-color:transparent;");
win = false;


});
/* sends to server msg to restart for all clients */
var restartmsg = function(){
    socket.emit("restartmsg", "restartmsg");
}
//setInterval(end_everything);
socket.on("close",end_everything);
</script>
</html>
